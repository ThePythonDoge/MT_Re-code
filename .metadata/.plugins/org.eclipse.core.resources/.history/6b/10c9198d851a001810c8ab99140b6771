package com.mortuusterra.listeners;

import org.bukkit.Material;
import org.bukkit.block.Block;
import org.bukkit.block.BlockFace;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.player.PlayerInteractEvent;
import org.bukkit.scheduler.BukkitRunnable;

import com.mortuusterra.MortuusTerraMain;
import com.mortuusterra.managers.MTGeck;

import net.md_5.bungee.api.ChatColor;

public class MTGeckListener implements Listener {

	private MortuusTerraMain main;
	private int i = 0;

	public MTGeckListener(MortuusTerraMain m) {
		this.main = m;
	}

	@EventHandler
	public void onInteract(PlayerInteractEvent e) {
		// e.getPlayer().sendMessage("test");
		// is the clicked block a lever
		if (e.getClickedBlock().getType().equals(Material.LEVER)) {
			Block lever = e.getClickedBlock();
			// is the block below the lever a sponge
			if (lever.getRelative(BlockFace.DOWN).getType().equals(Material.SPONGE)) {
				Block sponge = lever.getRelative(BlockFace.DOWN);
				BlockFace[] faces = { BlockFace.EAST, BlockFace.WEST, BlockFace.NORTH, BlockFace.SOUTH };
				for (BlockFace f : faces) {
					// are there pistons on the 4 horizontal sides of the sponge
					if (!sponge.getRelative(f).getType().equals(Material.PISTON_BASE)) {
						e.getPlayer().sendMessage("You must create the GECK correctly!");
						return;
					}
				}
				// TODO: is there a generator in range.
				// if the sponge/geck is already in the MTGeckList then dont do anything
				if (main.getRad().containsGeck(main.getRad().getGeck(sponge.getLocation()))) {
					return;
				}
				// else add the sponge/geck to the MTGeckList
				main.getRad().addGeck(new MTGeck(sponge.getLocation()));
				// Inform player that the new GECK has been build and now it needs to charge and
				// deradiate the air around it
				e.getPlayer()
						.sendMessage(ChatColor.BLUE + "You have succesfuly created a GECK" + ChatColor.WHITE + "("
								+ ChatColor.GRAY + "Garden of Eden Creation Kit" + ChatColor.WHITE + ")"
								+ ChatColor.BLUE + "!");
				e.getPlayer()
						.sendMessage(ChatColor.BLUE + "The GECK now will charge up and deradiate the air around it.");
				e.getPlayer()
						.sendMessage(ChatColor.BLUE + "Once finished there will be a " + ChatColor.GOLD
								+ "radiation free zone" + ChatColor.BLUE + "that is about " + ChatColor.GOLD
								+ "10 blocks " + ChatColor.BLUE + "in every direction around the GECK");
				e.getPlayer().sendMessage(ChatColor.BLUE + "GECK is now charging. Please wait!");
				new BukkitRunnable() {
					@Override
					public void run() {
						if (i == 0) {
							e.getPlayer().sendMessage(ChatColor.BLUE + "GECK progress: " + ChatColor.YELLOW + "0 "
									+ ChatColor.GOLD + "%");
						} else {
							e.getPlayer().sendMessage(ChatColor.BLUE + "GECK progress: " + ChatColor.YELLOW + i + "0 "
									+ ChatColor.GOLD + "%");
						}
						i++;
						if (i == 10) {
							e.getPlayer().sendMessage(ChatColor.BLUE + "GECK is now fully charged!");
							cancel();
						}
					}

				}.runTaskTimerAsynchronously(main, 0, 30);
			}
		}
		return;
	}

}
